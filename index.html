<!DOCTYPE html>
<html>
<head>
  <title></title>
  <link rel="stylesheet" type="text/css" href="./css/style.css">
</head>
<body>

<div id="container" style="height: 600px; min-width: 310px"></div>

<script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
<script src="https://code.highcharts.com/stock/highstock.js"></script>
<script src="https://code.highcharts.com/stock/modules/exporting.js"></script>
<script src="https://code.highcharts.com/stock/indicators/indicators.js"></script>
<script src="https://code.highcharts.com/stock/indicators/ichimoku-kinko-hyo.js"></script>

<script>
  var stockChart = null;
  var lastTime = null;
  var ohlc = [],
    volume = [];

  $.getJSON('http://localhost:3000/data?periods=60', function (fullData) {
    var data = fullData['result']['60'];

    // split the data set into ohlc and volume
    var dataLength = data.length,
      i = 0;

    for (i; i < dataLength; i += 1) {
      ohlc.push([
        data[i][0], // the date
        data[i][1], // open
        data[i][2], // high
        data[i][3], // low
        data[i][4] // close
      ]);

      volume.push([
        data[i][0], // the date
        data[i][5] // the volume
      ]);
    }

    lastTime = ohlc[ohlc.length - 1][0];

    stockChart = Highcharts.stockChart('container', {

      rangeSelector: {
        selected: 2
      },

      title: {
        text: 'AAPL Stock Price'
      },

      legend: {
        enabled: true
      },

      plotOptions: {
        series: {
          showInLegend: true
        }
      },

      series: [{
        type: 'candlestick',
        id: 'aapl',
        name: 'AAPL Stock Price',
        data: ohlc
      }, {
        type: 'ikh',
        linkedTo: 'aapl',
        tenkanLine: {
          styles: {
            lineColor: 'lightblue'
          }
        },
        kijunLine: {
          styles: {
            lineColor: 'darkred'
          }
        },
        chikouLine: {
          styles: {
            lineColor: 'lightgreen'
          }
        },
        senkouSpanA: {
          styles: {
            lineColor: 'green'
          }
        },
        senkouSpanB: {
          styles: {
            lineColor: 'red'
          }
        },
        senkouSpan: {
          styles: {
            fill: 'rgba(0, 255, 0, 0.1)'
          }
        }
      }]
    });
  });

  window.setInterval(function(){
    var url = 'http://localhost:3000/data?periods=60&after=' + lastTime;

    $.getJSON(url, function (full_data) {
      var lastData = full_data["result"]['60'];
      if(lastData) {
        var lastDataLength = lastData.length;
        console.log(lastDataLength);
        if (lastDataLength === 1) {
          // update last item
          ohlc[ohlc.length - 1] = [
            lastData[0][0], // the date
            lastData[0][1], // open
            lastData[0][2], // high
            lastData[0][3], // low
            lastData[0][4] // close
          ];

          volume[volume.length - 1] = [
            lastData[0][0], // the date
            lastData[0][5] // the volume
          ];

        } else if (lastDataLength > 1) {
          lastTime = lastData[lastDataLength - 1][0];

          // check and get list last data
          var indexLastOhlc = lastData.findIndex(item => item[0] === ohlc[ohlc.length - 1][0]);
          lastData =  lastData.slice(indexLastOhlc);

          // remove last item
          ohlc.splice(-1,1);
          volume.splice(-1,1);

          // append data item
          var i = 0;
          for (i; i < lastData.length; i += 1) {
            ohlc.push([
              lastData[i][0], // the date
              lastData[i][1], // open
              lastData[i][2], // high
              lastData[i][3], // low
              lastData[i][4] // close
            ]);

            volume.push([
              lastData[i][0], // the date
              lastData[i][5] // the volume
            ]);
          }
        }

        stockChart.series[0].setData(ohlc, true);
        stockChart.series[1].setData(volume, true);
        stockChart.redraw();
      }
    });
  }, 5000);

  function redrawChart(stockChart, ohlc, volume) {
    stockChart.series[0].setData(ohlc, true);
    stockChart.series[1].setData(volume, true);
    stockChart.redraw();
  }
</script>
</body>
</html>